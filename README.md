# Пример использования Cloud Gateway MVC + Keycloak

Реализация примера для обмена по схеме

![img.png](resources/schema.png)

В примере не будет фронта и прокси, т.к. пример направлен именно на реализацию бэк части такой системы.

## keycloak

В keycloak должен быть создан отдельный реалм, 
т.к. использование master приведет к тому, что под администратором кейклока можно будет войти в систему.
Это усложняет проверку работоспособности системы под другими пользователями 
(из одного браузера просто будет невозможно находится и в админке кейклока и в разрабатываемой системе)

### Создание реалма
![img.png](resources/realm.png)

Далее в кейклоке нужно завести клиента, через которого будет осуществляться авторизация пользователей

### Создание клиента
![img_1.png](resources/client-general.png)

![img_2.png](resources/client-capability.png)

![img_3.png](resources/client-urls.png)

Важно указать валидный шаблон урлов для редиректа (по сути должен состоять из путей развернутой системы, 
в нашем случае это любой путь сервиса api-gateway). 
При использовании прокси должны быть указаны именно проксированные урлы.

## test-service

Пример закрытого ресурса с получением разной информации в зависимости от роли.

Важно:
- для работы сваггера должен быть задан урл сервиса ведущий на прокси (см. SwaggerConfig.class)
![img.png](resources/swagger-code.png)
![img_1.png](resources/swagger-config.png)
- для удобства всем сервисам ресурсов лучше указывать уникальный context-path, по которому будет api-gateway фильтровать запросы

## api-gateway

Пример реализации шлюза с проверкой авторизации.

Важно:
- для логирования пересылаемых запросов можно добавить перехватчик в RestClient (см. SecurityConfig.class)
![img.png](resources/log-gateway.png)
- для проверки токена необходимо добавить фильтр TokenRelay в секцию с маршрутизацией
![img_1.png](resources/token-gateway.png)
- для работы сваггеров закрытых сервисов необходимо добавить в исключения проверок безопасности пути: "/swagger-ui/**",
  "/*/api-docs/**"

## Использованные в работе ресурсы

- https://habr.com/ru/articles/872856/
- https://spring.io/blog/2019/08/16/securing-services-with-spring-cloud-gateway
